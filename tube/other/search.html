<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wool-Tube</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #000066; min-height: 100vh; padding: 20px; transition: background 0.3s; }
        body.light-mode { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: white; text-align: center; margin-bottom: 30px; font-size: 2.5em; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; gap: 15px; }
        .logo { width: 80px; height: 80px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 45px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        .search-box { background: linear-gradient(135deg, #4a0e34 0%, #2d1b3d 100%); padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-bottom: 30px; transition: background 0.3s; }
        body.light-mode .search-box { background: white; }
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        input[type="text"] { flex: 1; padding: 15px; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; font-size: 16px; transition: border-color 0.3s, background 0.3s; background: #000000; color: white; }
        body.light-mode input[type="text"] { background: white; color: #333; border: 2px solid #e0e0e0; }
        input[type="text"]::placeholder { color: rgba(255,255,255,0.5); }
        body.light-mode input[type="text"]::placeholder { color: rgba(0,0,0,0.5); }
        input[type="text"]:focus { outline: none; border-color: #7b1fa2; background: #1a1a1a; }
        body.light-mode input[type="text"]:focus { background: #f9f9f9; border-color: #7b1fa2; }
        button { padding: 15px 30px; background: linear-gradient(135deg, #7b1fa2 0%, #4a148c 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(123,31,162,0.5); }
        button:active { transform: translateY(0); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .player-section { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-bottom: 30px; }
        #player { width: 100%; aspect-ratio: 16/9; border-radius: 10px; background: #000; }
        #playerContainer { width: 100%; aspect-ratio: 16/9; border-radius: 10px; overflow: hidden; background: #000; }
        video { width: 100%; height: 100%; border-radius: 10px; }
        .controls { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .controls button { flex: 1; min-width: 100px; }
        .quality-controls { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 15px; }
        .quality-controls button { min-width: 120px; padding: 12px 20px; font-size: 14px; }
        .quality-controls button.active { background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%); box-shadow: 0 3px 10px rgba(76,175,80,0.4); }
        .results { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .video-card { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.2); cursor: pointer; transition: transform 0.3s, box-shadow 0.3s; }
        .video-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .video-card img { width: 100%; height: 180px; object-fit: cover; }
        .video-info { padding: 15px; }
        .video-title { font-weight: bold; margin-bottom: 8px; font-size: 14px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .video-channel { color: #666; font-size: 12px; }
        .loading { text-align: center; color: white; font-size: 18px; margin: 20px 0; }
        .error { background: #ff5252; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .info { background: #4CAF50; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        #currentVideo { text-align: center; margin-bottom: 15px; font-size: 18px; font-weight: bold; color: #333; }
        .stream-url { margin-top: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px; font-size: 12px; word-break: break-all; }
        .api-note { font-size: 12px; color: rgba(255,255,255,0.9); margin-top: 10px; transition: color 0.3s; }
        body.light-mode .api-note { color: #666; }
        .theme-toggle { position: fixed; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border: none; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; font-size: 24px; display: flex; align-items: center; justify-content: center; transition: all 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1000; }
        .theme-toggle:hover { transform: scale(1.1); background: rgba(255,255,255,0.3); }
        body.light-mode .theme-toggle { background: rgba(0,0,0,0.1); }
        body.light-mode .theme-toggle:hover { background: rgba(0,0,0,0.2); }
        select { appearance: none; background-image: url('data:image/svg+xml;charset=UTF-8,%3Csvg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12"%3E%3Cpath fill="%23ffffff" d="M6 9L1 4h10z"/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 15px center; padding-right: 40px; }
        body.light-mode select { background-color: white; color: #333; border: 2px solid #e0e0e0; background-image: url('data:image/svg+xml;charset=UTF-8,%3Csvg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12"%3E%3Cpath fill="%23333333" d="M6 9L1 4h10z"/%3E%3C/svg%3E'); }
        select:focus { outline: none; border-color: #7b1fa2; background-color: #1a1a1a; }
        body.light-mode select:focus { background-color: #f9f9f9; }
        select option { background: #000000; color: white; padding: 10px; }
        body.light-mode select option { background: white; color: #333; }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">üåô</button>
    <div class="container">
        <h1><div class="logo">üêë</div>Wool-Tube</h1>
        <div class="search-box">
            <div class="input-group">
                <select id="apiKeySelect" style="flex: 1; padding: 15px; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; font-size: 16px; background: #000000; color: white; cursor: pointer;">
                    <option value="">YouTube Data API Key „ÇíÈÅ∏ÊäûÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ</option>
                    <option value="AIzaSyCz7f0X_giaGyC9u1EfGZPBuAC9nXiL5Mo">API Key 1</option>
                    <option value="AIzaSyBmzCw7-sX1vm-uL_u2Qy3LuVZuxye4Wys">API Key 2</option>
                    <option value="custom">„Ç´„Çπ„Çø„É†API„Ç≠„Éº„ÇíÂÖ•Âäõ...</option>
                </select>
            </div>
            <div class="input-group" id="customKeyInput" style="display: none;">
                <input type="text" id="apiKey" placeholder="„Ç´„Çπ„Çø„É†Google API Key„ÇíÂÖ•Âäõ">
            </div>
            <div class="input-group">
                <input type="text" id="searchQuery" placeholder="Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„Åæ„Åü„ÅØYouTube URL„ÇíÂÖ•Âäõ" onkeypress="if(event.key==='Enter') searchVideos()">
                <button onclick="searchVideos()">üîç Ê§úÁ¥¢</button>
            </div>
            <div class="api-note">‚ÄªYouTube Data API Key„ÅßÊúÄÂ§ß50‰ª∂„ÄÅInvidious„Åß40‰ª∂‰ª•‰∏ä„ÅÆÊ§úÁ¥¢ÁµêÊûú</div>
        </div>
        <div class="player-section" id="playerSection" style="display: none;">
            <div id="currentVideo"></div>
            <div id="playerContainer"><iframe id="player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
            <div class="controls">
                <button onclick="setPlayMode('stream')" id="btnStream">üé¨ „Çπ„Éà„É™„Éº„É†</button>
                <button onclick="setPlayMode('embed')">üì∫ Âüã„ÇÅËæº„Åø</button>
                <button onclick="toggleLoop()" id="btnLoop">üîÅ „É™„Éî„Éº„Éà: OFF</button>
            </div>
            <div class="quality-controls" id="qualityControls" style="display: none;"></div>
            <div class="stream-url" id="streamUrl"></div>
        </div>
        <div id="loading" class="loading" style="display: none;">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="info" class="info" style="display: none;"></div>
        <div class="results" id="results"></div>
    </div>
    <script>
        let currentVideoId = null, availableStreams = [], currentPlayMode = 'embed', isLoopEnabled = false;
        const GOOGLE_CSE_IDS = ['208525a8a6ab2430a', 'd3b864851ecd94e6a', 'e3c4d5f6a7b8c9d0e'];
        const streamAPIs = [{name: 'Invidious', servers: ['https://inv.nadeko.net', 'https://yewtu.be', 'https://invidious.nerdvpn.de', 'https://vid.puffyan.us'], getUrl: (s, v) => `${s}/api/v1/videos/${v}`, parseResponse: (d) => { const st = []; if (d.formatStreams) d.formatStreams.forEach(s => { if (s.url) st.push({url: s.url, quality: s.qualityLabel || s.quality || 'unknown', type: 'Invidious', hasAudio: true}); }); return st; }}];
        
        function toggleLoop() { isLoopEnabled = !isLoopEnabled; const btn = document.getElementById('btnLoop'); btn.textContent = isLoopEnabled ? 'üîÅ „É™„Éî„Éº„Éà: ON' : 'üîÅ „É™„Éî„Éº„Éà: OFF'; btn.style.background = isLoopEnabled ? 'linear-gradient(135deg, #4CAF50 0%, #388E3C 100%)' : 'linear-gradient(135deg, #7b1fa2 0%, #4a148c 100%)'; applyLoopToCurrentPlayer(); showInfo(`„É™„Éî„Éº„Éà${isLoopEnabled ? 'ON' : 'OFF'}`); }
        function applyLoopToCurrentPlayer() { const p = document.getElementById('player'); if (currentPlayMode === 'stream' && p && p.tagName === 'VIDEO') p.loop = isLoopEnabled; else if (p && p.tagName === 'IFRAME' && currentVideoId) { let src = p.src.replace(/[&?]loop=\d+/, '').replace(/[&?]playlist=[^&]+/, ''); if (isLoopEnabled) src += `${src.includes('?') ? '&' : '?'}loop=1&playlist=${currentVideoId}`; p.src = src; }}
        function toggleTheme() { document.body.classList.toggle('light-mode'); document.getElementById('themeToggle').textContent = document.body.classList.contains('light-mode') ? '‚òÄÔ∏è' : 'üåô'; }
        document.addEventListener('DOMContentLoaded', () => { document.getElementById('apiKeySelect').addEventListener('change', function() { document.getElementById('customKeyInput').style.display = this.value === 'custom' ? 'flex' : 'none'; }); });
        
        async function searchVideos() {
            const query = document.getElementById('searchQuery').value.trim();
            const apiKeySelect = document.getElementById('apiKeySelect');
            const customApiKey = document.getElementById('apiKey');
            let apiKey = apiKeySelect.value === 'custom' ? customApiKey.value.trim() : apiKeySelect.value;
            const loading = document.getElementById('loading'), error = document.getElementById('error'), info = document.getElementById('info'), results = document.getElementById('results');
            error.style.display = 'none'; info.style.display = 'none'; results.innerHTML = '';
            if (!query) { showError('Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
            const videoIdMatch = query.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\s]+)/);
            if (videoIdMatch) { playVideo(videoIdMatch[1], 'YouTubeÂãïÁîª'); return; }
            loading.style.display = 'block'; showInfo('Ê§úÁ¥¢‰∏≠...');
            
            if (apiKey) {
                try {
                    const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=50&q=${encodeURIComponent(query)}&type=video&key=${apiKey}`, {signal: AbortSignal.timeout(15000)});
                    if (res.ok) { const data = await res.json(); if (data.items && data.items.length > 0) { displayGoogleResults(data.items); loading.style.display = 'none'; showInfo(`‚úÖ YouTube Data API „Åß${data.items.length}‰ª∂`); return; }}
                } catch (e) {}
            }
            
            const cseKeys = ['AIzaSyCXuHXy7PWFcXpXNuNnuWYRqU1Uu5Z2q_g', 'AIzaSyDQABKeZuMuGiGUxVl8qLW2bz_3nT6DZF8'];
            let allCse = [], seenIds = new Set();
            for (const cseId of GOOGLE_CSE_IDS) {
                for (const key of cseKeys) {
                    try {
                        const res = await fetch(`https://www.googleapis.com/customsearch/v1?key=${key}&cx=${cseId}&q=${encodeURIComponent(query + ' site:youtube.com')}&num=10`, {signal: AbortSignal.timeout(15000)});
                        if (res.ok) { const data = await res.json(); if (data.items) data.items.forEach(item => { const m = item.link.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\s]+)/); if (m && !seenIds.has(m[1])) { seenIds.add(m[1]); allCse.push(item); }}); if (allCse.length >= 30) { displayCSEResults(allCse); loading.style.display = 'none'; showInfo(`‚úÖ CSE „Åß${allCse.length}‰ª∂`); return; }}
                    } catch (e) {}
                }
            }
            if (allCse.length > 0) { displayCSEResults(allCse); loading.style.display = 'none'; showInfo(`‚úÖ CSE „Åß${allCse.length}‰ª∂`); return; }
            
            const invServers = ['https://inv.nadeko.net', 'https://yewtu.be', 'https://invidious.nerdvpn.de', 'https://vid.puffyan.us', 'https://invidious.privacydev.net', 'https://iv.melmac.space'];
            let allInv = [], seenInvIds = new Set();
            for (const srv of invServers) {
                try {
                    const res = await fetch(`${srv}/api/v1/search?q=${encodeURIComponent(query)}&type=video`, {signal: AbortSignal.timeout(10000)});
                    if (res.ok) { const data = await res.json(); if (Array.isArray(data)) data.forEach(item => { if (item.videoId && !seenInvIds.has(item.videoId)) { seenInvIds.add(item.videoId); allInv.push(item); }}); if (allInv.length >= 40) { displayInvidiousResults(allInv); loading.style.display = 'none'; showInfo(`‚úÖ Invidious „Åß${allInv.length}‰ª∂`); return; }}
                } catch (e) {}
            }
            if (allInv.length > 0) { displayInvidiousResults(allInv); loading.style.display = 'none'; showInfo(`‚úÖ Invidious „Åß${allInv.length}‰ª∂`); return; }
            displayPopularVideos(); loading.style.display = 'none'; showInfo('‚ö†Ô∏è ‰∫∫Ê∞óÂãïÁîª„ÇíË°®Á§∫');
        }
        
        function displayPopularVideos() {
            const vids = [{id: 'dQw4w9WgXcQ', title: 'Rick Astley - Never Gonna Give You Up', channel: 'Rick Astley'}, {id: 'kJQP7kiw5Fk', title: 'Despacito', channel: 'Luis Fonsi'}, {id: 'JGwWNGJdvx8', title: 'Shape of You', channel: 'Ed Sheeran'}, {id: 'OPf0YbXqDm0', title: 'Uptown Funk', channel: 'Mark Ronson'}, {id: 'CevxZvSJLk8', title: 'Roar', channel: 'Katy Perry'}, {id: '2Vv-BfVoq4g', title: 'GANGNAM STYLE', channel: 'PSY'}, {id: 'RgKAFK5djSk', title: 'See You Again', channel: 'Wiz Khalifa'}, {id: 'fRh_vgS2dFE', title: 'Sorry', channel: 'Justin Bieber'}, {id: 'lXMskKTw3Bc', title: 'Sugar', channel: 'Maroon 5'}, {id: 'hTWKbfoikeg', title: 'Smells Like Teen Spirit', channel: 'Nirvana'}, {id: 'YQHsXMglC9A', title: 'Hello', channel: 'Adele'}, {id: 'SlPhMPnQ58k', title: 'Someone Like You', channel: 'Adele'}, {id: 'CvBfHwUxHIk', title: 'Believer', channel: 'Imagine Dragons'}, {id: 'RBumgq5yVrA', title: 'Let Her Go', channel: 'Passenger'}, {id: 'nfWlot6h_JM', title: 'Shake It Off', channel: 'Taylor Swift'}, {id: 'F57P9C4SAW4', title: 'Somebody That I Used To Know', channel: 'Gotye'}, {id: 'iS1g8G_njx8', title: 'Grenade', channel: 'Bruno Mars'}, {id: 'Pkh8UtuejGw', title: 'Counting Stars', channel: 'OneRepublic'}, {id: 'ru0K8uYEZWw', title: 'Closer', channel: 'The Chainsmokers'}, {id: 'pRpeEdMmmQ0', title: 'Waka Waka', channel: 'Shakira'}, {id: 'fLexgOxsZu0', title: 'Baby', channel: 'Justin Bieber'}, {id: 'lp-EO5I60KA', title: 'Party Rock Anthem', channel: 'LMFAO'}, {id: 'nIjVuRTm-dc', title: 'Timber', channel: 'Pitbull'}, {id: 'M11SvDtPBhA', title: 'Diamonds', channel: 'Rihanna'}, {id: 'e-ORhEE3VVg', title: 'Firework', channel: 'Katy Perry'}, {id: 'FlsCjmMhFmw', title: 'Call Me Maybe', channel: 'Carly Rae Jepsen'}, {id: 'pt8VYOfr8To', title: 'Love Me Like You Do', channel: 'Ellie Goulding'}, {id: 'pa14VNsdSYM', title: 'Chandelier', channel: 'Sia'}, {id: '60ItHLz5WEA', title: 'Faded', channel: 'Alan Walker'}, {id: 'W3GrSMYbkBE', title: 'Happy', channel: 'Pharrell'}, {id: 'UceaB4D0jpo', title: 'A Sky Full Of Stars', channel: 'Coldplay'}, {id: 'FM7MFYoylVs', title: 'All About That Bass', channel: 'Meghan Trainor'}, {id: 'LsoLEjrDogU', title: 'Summer', channel: 'Calvin Harris'}, {id: 'Io0fBr1XBUA', title: 'Titanium', channel: 'David Guetta'}, {id: 'djV11Xbc914', title: 'Wake Me Up', channel: 'Avicii'}, {id: 'HgzGwKwLmgM', title: 'Don\'t Stop Me Now', channel: 'Queen'}, {id: 'fJ9rUzIMcZQ', title: 'Bohemian Rhapsody', channel: 'Queen'}, {id: '1w7OgIMMRc4', title: 'Sweet Child O\' Mine', channel: 'Guns N\' Roses'}, {id: 'rY0WxgSXdEE', title: 'Thunderstruck', channel: 'AC/DC'}, {id: 'L_jWHffIx5E', title: 'All Star', channel: 'Smash Mouth'}, {id: 'eVTXPUF4Oz4', title: 'In The End', channel: 'Linkin Park'}, {id: 'kXYiU_JCYtU', title: 'Numb', channel: 'Linkin Park'}, {id: 'CD-E-LDc384', title: 'Zombie', channel: 'Cranberries'}, {id: '9jK-NcRmVcw', title: 'Europe - The Final Countdown', channel: 'Europe'}, {id: 'ZyhrYis509A', title: 'Mr. Brightside', channel: 'The Killers'}, {id: 'A_MjCqQoLLA', title: 'Hey Jude', channel: 'The Beatles'}, {id: 'tbNlMtqrYS0', title: 'Stairway to Heaven', channel: 'Led Zeppelin'}, {id: 'IxuThNgl3YA', title: 'Billie Jean', channel: 'Michael Jackson'}, {id: 'fJ9rUzIMcZQ', title: 'Bohemian Rhapsody', channel: 'Queen'}, {id: 'fiore9Z5iUg', title: 'Rolling in the Deep', channel: 'Adele'}];
            vids.forEach(v => { const card = document.createElement('div'); card.className = 'video-card'; card.onclick = () => playVideo(v.id, v.title); card.innerHTML = `<img src="https://img.youtube.com/vi/${v.id}/mqdefault.jpg" alt="${v.title}"><div class="video-info"><div class="video-title">${v.title}</div><div class="video-channel">${v.channel}</div></div>`; document.getElementById('results').appendChild(card); });
        }
        
        function displayInvidiousResults(items) {
            items.forEach(item => { if (!item.videoId) return; const card = document.createElement('div'); card.className = 'video-card'; card.onclick = () => playVideo(item.videoId, item.title); let thumb = `https://img.youtube.com/vi/${item.videoId}/mqdefault.jpg`; if (item.videoThumbnails && item.videoThumbnails[0]) { const t = item.videoThumbnails.find(x => x.quality === 'medium') || item.videoThumbnails[0]; if (t.url) thumb = t.url.startsWith('http') ? t.url : 'https:' + t.url; } card.innerHTML = `<img src="${thumb}" alt="${item.title || 'Video'}" onerror="this.src='https://img.youtube.com/vi/${item.videoId}/mqdefault.jpg'"><div class="video-info"><div class="video-title">${item.title || 'Untitled'}</div><div class="video-channel">${item.author || 'Unknown'}</div></div>`; document.getElementById('results').appendChild(card); });
        }
        
        function displayCSEResults(items) {
            items.forEach(item => { const m = item.link.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\s]+)/); if (!m) return; const vid = m[1]; const card = document.createElement('div'); card.className = 'video-card'; card.onclick = () => playVideo(vid, item.title); let thumb = `https://img.youtube.com/vi/${vid}/mqdefault.jpg`; if (item.pagemap && item.pagemap.cse_thumbnail && item.pagemap.cse_thumbnail[0]) thumb = item.pagemap.cse_thumbnail[0].src; card.innerHTML = `<img src="${thumb}" alt="${item.title}"><div class="video-info"><div class="video-title">${item.title.replace(' - YouTube', '')}</div><div class="video-channel">${(item.snippet || '').substring(0, 100)}</div></div>`; document.getElementById('results').appendChild(card); });
        }
        
        function displayGoogleResults(items) {
            items.forEach(item => { const card = document.createElement('div'); card.className = 'video-card'; card.onclick = () => playVideo(item.id.videoId, item.snippet.title); card.innerHTML = `<img src="${item.snippet.thumbnails.medium.url}" alt="${item.snippet.title}"><div class="video-info"><div class="video-title">${item.snippet.title}</div><div class="video-channel">${item.snippet.channelTitle}</div></div>`; document.getElementById('results').appendChild(card); });
        }
        
        function playVideo(videoId, title) {
            currentVideoId = videoId; availableStreams = []; currentPlayMode = 'embed';
            document.getElementById('playerSection').style.display = 'block';
            document.getElementById('currentVideo').textContent = title;
            const cont = document.getElementById('playerContainer');
            cont.innerHTML = `<iframe id="player" width="100%" height="100%" src="https://www.youtube.com/embed/${videoId}?autoplay=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
            document.getElementById('streamUrl').textContent = `Âüã„ÇÅËæº„ÅøÂÜçÁîü | https://www.youtube.com/watch?v=${videoId}`;
            const btnStream = document.getElementById('btnStream');
            btnStream.disabled = true; btnStream.textContent = 'üé¨ ÂèñÂæó‰∏≠...';
            fetchStreamUrls(videoId).then(streams => { if(streams.length > 0) { availableStreams = streams; btnStream.disabled = false; btnStream.textContent = 'üé¨ „Çπ„Éà„É™„Éº„É†'; showInfo(`„Çπ„Éà„É™„Éº„É†ÂÜçÁîü„ÅåÂà©Áî®ÂèØËÉΩ„Åß„Åô`); setPlayMode('stream'); } else { btnStream.disabled = true; btnStream.textContent = 'üé¨ Âà©Áî®‰∏çÂèØ'; }}).catch(() => { btnStream.disabled = true; btnStream.textContent = 'üé¨ „Ç®„É©„Éº'; });
            document.getElementById('playerSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        async function fetchStreamUrls(videoId) {
            for (const api of streamAPIs) {
                for (const server of api.servers) {
                    try {
                        const res = await fetch(api.getUrl(server, videoId), {signal: AbortSignal.timeout(8000)});
                        if (res.ok) { const data = await res.json(); const streams = api.parseResponse(data); if (streams.length > 0) return streams; }
                    } catch (e) { continue; }
                }
            }
            return [];
        }
        
        function setPlayMode(mode) {
            if (!currentVideoId) return;
            currentPlayMode = mode;
            const cont = document.getElementById('playerContainer'), streamUrl = document.getElementById('streamUrl'), qualityControls = document.getElementById('qualityControls');
            streamUrl.textContent = ''; qualityControls.style.display = 'none';
            
            if (mode === 'stream') {
                if (availableStreams.length === 0) { showError('„Çπ„Éà„É™„Éº„É†ÊÉÖÂ†±„Å™„Åó'); return; }
                cont.innerHTML = '<video id="player" controls autoplay style="width:100%;height:100%;"></video>';
                qualityControls.style.display = 'grid'; createQualityButtons(); playBestQuality();
                setTimeout(() => applyLoopToCurrentPlayer(), 100);
                return;
            }
            
            let embedUrl = mode === 'embed' ? `https://www.youtube.com/embed/${currentVideoId}?autoplay=1` : `https://www.youtube-nocookie.com/embed/${currentVideoId}?autoplay=1`;
            if (isLoopEnabled) embedUrl += `&loop=1&playlist=${currentVideoId}`;
            cont.innerHTML = `<iframe id="player" width="100%" height="100%" src="${embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
            streamUrl.textContent = mode === 'embed' ? `Âüã„ÇÅËæº„ÅøÂÜçÁîü` : `No CookieÂüã„ÇÅËæº„Åø`;
        }
        
        function createQualityButtons() {
            const qc = document.getElementById('qualityControls'); qc.innerHTML = '';
            const audioStreams = availableStreams.filter(s => s.hasAudio);
            const sortable = audioStreams.length > 0 ? audioStreams : availableStreams;
            const qualityMap = new Map(); sortable.forEach(s => { const q = String(s.quality); if (!qualityMap.has(q)) qualityMap.set(q, s); });
            const sorted = Array.from(qualityMap.entries()).sort((a, b) => { const getVal = q => { const m = q.match(/(\d+)/); return m ? parseInt(m[1]) : 0; }; return getVal(b[0]) - getVal(a[0]); });
            sorted.forEach(([quality, stream], idx) => { const btn = document.createElement('button'); btn.textContent = `${quality} ${stream.hasAudio ? 'üîä' : 'üîá'}`; btn.onclick = () => changeQualityByIndex(idx); btn.dataset.index = idx; qc.appendChild(btn); });
        }
        
        function playBestQuality() { changeQualityByIndex(0); }
        
        function changeQualityByIndex(index) {
            const audioStreams = availableStreams.filter(s => s.hasAudio);
            const sortable = audioStreams.length > 0 ? audioStreams : availableStreams;
            const qualityMap = new Map(); sortable.forEach(s => { const q = String(s.quality); if (!qualityMap.has(q)) qualityMap.set(q, s); });
            const sorted = Array.from(qualityMap.entries()).sort((a, b) => { const getVal = q => { const m = q.match(/(\d+)/); return m ? parseInt(m[1]) : 0; }; return getVal(b[0]) - getVal(a[0]); });
            if (index >= sorted.length) return;
            const [quality, selectedStream] = sorted[index];
            const qc = document.getElementById('qualityControls'); const btns = qc.querySelectorAll('button');
            btns.forEach((btn, i) => { if (i === index) btn.classList.add('active'); else btn.classList.remove('active'); });
            playStream(selectedStream);
        }
        
        function playStream(stream) {
            if (!stream || !stream.url) { showError('„Çπ„Éà„É™„Éº„É†Ë™≠„ÅøËæº„ÅøÂ§±Êïó'); return; }
            const player = document.getElementById('player');
            player.src = stream.url; player.play().catch(e => showError('ÂÜçÁîü„Ç®„É©„Éº'));
            document.getElementById('streamUrl').textContent = `ÁîªË≥™: ${stream.quality} | API: ${stream.type} ${stream.hasAudio ? 'üîä' : 'üîá'}`;
        }
        
        function showError(msg) { const err = document.getElementById('error'); err.textContent = msg; err.style.display = 'block'; setTimeout(() => err.style.display = 'none', 5000); }
        function showInfo(msg) { const inf = document.getElementById('info'); inf.textContent = msg; inf.style.display = 'block'; setTimeout(() => inf.style.display = 'none', 3000); }
    </script>
</body>
</html>
