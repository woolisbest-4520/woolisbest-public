<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>タイピングゲーム（チート&難易度付き）</title>
<style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; position: relative; }
    #word { font-size: 28px; margin-bottom: 20px; }
    #inputBox { font-size: 24px; padding: 5px; width: 500px; }
    #result { margin-top: 20px; font-size: 22px; }
    #timer { margin-top: 10px; font-size: 20px; color: red; }
    #scoreBoard { margin-top: 20px; font-size: 20px; }
    #maxComboDisplay { position: absolute; top: 10px; right: 10px; font-size: 18px; background-color: #f0f0f0; padding: 5px 10px; border-radius: 5px; border: 1px solid #ccc; }
    #difficulty { margin-bottom: 20px; font-size: 18px; }
</style>
</head>
<body>
<h1>タイピングゲーム（チート&難易度付き）</h1>
<div id="maxComboDisplay">最高連続正解: 0</div>

<!-- 難易度選択 -->
<div id="difficulty">
    難易度: 
    <select id="difficultySelect">
        <option value="easy">簡単</option>
        <option value="normal" selected>普通</option>
        <option value="hard">難しい</option>
    </select>
</div>

<div id="word">準備中...</div>
<input type="text" id="inputBox" placeholder="ここにローマ字で入力してください">
<div id="timer"></div>
<div id="result"></div>
<div id="scoreBoard">スコア: 0 | 連続正解: 0 | ミス: 0</div>

<script>
// --- 単語データ ---
const nouns = ["さくら", "ねこ", "りんご", "みかん", "いぬ", "ゲーム", "コンピュータ", "うみ", "やま", "そら"];
const verbs = ["たべる", "みる", "いく", "かく", "およぐ", "ねる", "よむ", "はしる"];
const adjectives = ["おいしい", "たのしい", "あたらしい", "ふるい", "きれい", "むずかしい"];

const hiraganaChars = "あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわをん";
const alphabetChars = "abcdefghijklmnopqrstuvwxyz";

// --- ローマ字変換 ---
const kanaMap = {
    'あ':'a','い':'i','う':'u','え':'e','お':'o',
    'か':'ka','き':'ki','く':'ku','け':'ke','こ':'ko',
    'さ':'sa','し':'shi','す':'su','せ':'se','そ':'so',
    'た':'ta','ち':'chi','つ':'tsu','て':'te','と':'to',
    'な':'na','に':'ni','ぬ':'nu','ね':'ne','の':'no',
    'は':'ha','ひ':'hi','ふ':'fu','へ':'he','ほ':'ho',
    'ま':'ma','み':'mi','む':'mu','め':'me','も':'mo',
    'や':'ya','ゆ':'yu','よ':'yo',
    'ら':'ra','り':'ri','る':'ru','れ':'re','ろ':'ro',
    'わ':'wa','を':'wo','ん':'n',
    'が':'ga','ぎ':'gi','ぐ':'gu','げ':'ge','ご':'go',
    'ざ':'za','じ':'ji','ず':'zu','ぜ':'ze','ぞ':'zo',
    'だ':'da','ぢ':'ji','づ':'zu','で':'de','ど':'do',
    'ば':'ba','び':'bi','ぶ':'bu','べ':'be','ぼ':'bo',
    'ぱ':'pa','ぴ':'pi','ぷ':'pu','ぺ':'pe','ぽ':'po',
    'きゃ':'kya','きゅ':'kyu','きょ':'kyo',
    'しゃ':'sha','しゅ':'shu','しょ':'sho',
    'ちゃ':'cha','ちゅ':'chu','ちょ':'cho',
    'にゃ':'nya','にゅ':'nyu','にょ':'nyo',
    'ひゃ':'hya','ひゅ':'hyu','ひょ':'hyo',
    'みゃ':'mya','みゅ':'myu','みょ':'myo',
    'りゃ':'rya','りゅ':'ryu','りょ':'ryo',
    'ぎゃ':'gya','ぎゅ':'gyu','ぎょ':'gyo',
    'じゃ':'ja','じゅ':'ju','じょ':'jo',
    'びゃ':'bya','びゅ':'byu','びょ':'byo',
    'ぴゃ':'pya','ぴゅ':'pyu','ぴょ':'pyo'
};

function toRomaji(str) {
    let result = "", i = 0;
    while(i<str.length){
        if(i+1<str.length && kanaMap[str[i]+str[i+1]]) { result+=kanaMap[str[i]+str[i+1]]; i+=2; }
        else if(kanaMap[str[i]]) { result+=kanaMap[str[i]]; i+=1; }
        else { result+=str[i]; i+=1; }
    }
    return result;
}

// --- 単語生成 ---
function generateWord() {
    const noun = nouns[Math.floor(Math.random()*nouns.length)];
    const verb = verbs[Math.floor(Math.random()*verbs.length)];
    const adj = adjectives[Math.floor(Math.random()*adjectives.length)];
    const sentence = Math.random()<0.5 ? `${adj} ${noun} ${verb}` : `${noun} ${verb}`;
    return {jp: sentence, romaji: toRomaji(sentence)};
}

// --- ランダム文字列生成 ---
function generateRandomString(difficulty="normal") {
    let length, hiraRatio;
    switch(difficulty){
        case "easy": length=3+Math.floor(Math.random()*3); hiraRatio=0.8; break;
        case "normal": length=5+Math.floor(Math.random()*5); hiraRatio=0.5; break;
        case "hard": length=8+Math.floor(Math.random()*5); hiraRatio=0.3; break;
        default: length=5; hiraRatio=0.5;
    }
    let str="";
    for(let i=0;i<length;i++){
        const charSet = Math.random()<hiraRatio ? hiraganaChars : alphabetChars;
        str+=charSet[Math.floor(Math.random()*charSet.length)];
    }
    return {jp:str, romaji:toRomaji(str)};
}

// --- 出題選択 ---
function getNextWord() {
    const difficulty = document.getElementById("difficultySelect").value;
    if(Math.random()<0.7) return generateWord();
    else return generateRandomString(difficulty);
}

// --- ゲーム本体 ---
let currentWord={}, startTime, timerId, timeLimit;
let score=0, combo=0, maxCombo=0, mistakes=0;

function updateScoreBoard(){
    document.getElementById("scoreBoard").textContent=`スコア: ${score} | 連続正解: ${combo} | ミス: ${mistakes}`;
    document.getElementById("maxComboDisplay").textContent=`最高連続正解: ${maxCombo}`;
}

function getLength(str){ return Array.from(str).length; }

function newWord(){
    clearInterval(timerId);
    currentWord=getNextWord();
    document.getElementById("word").textContent=currentWord.jp;
    document.getElementById("inputBox").value="";
    document.getElementById("result").textContent="";
    timeLimit = getLength(currentWord.romaji)*0.5;
    startTime = new Date();
    document.getElementById("inputBox").focus();
    timerId=setInterval(updateTimer,100);
}

function updateTimer(){
    const elapsed=(new Date()-startTime)/1000;
    const remaining=(timeLimit-elapsed).toFixed(1);
    document.getElementById("timer").textContent=`残り時間: ${remaining>0?remaining:0} 秒`;
    if(remaining<=0){
        clearInterval(timerId);
        document.getElementById("result").textContent=`時間切れ！正しい単語は "${currentWord.romaji}" でした。`;
        combo=0; mistakes++; updateScoreBoard();
        setTimeout(newWord,1500);
    }
}

// --- 入力判定 ---
document.getElementById("inputBox").addEventListener("input", function(){
    let userInput=this.value.toLowerCase();
    const cheatActive = userInput.includes('*');

    if(cheatActive || currentWord.romaji.startsWith(userInput)){
        // 正しい範囲またはチート
    } else {
        mistakes++;
        combo = 0;
        updateScoreBoard();
        document.getElementById("result").textContent = "ミスタイプ！再入力してください";
        this.value = "";
    }

    if(cheatActive || userInput === currentWord.romaji){
        clearInterval(timerId);
        const elapsed = ((new Date()-startTime)/1000).toFixed(2);
        if(cheatActive) {
            document.getElementById("result").textContent = "チート成功！自動クリア";
        } else {
            document.getElementById("result").textContent = `正解！かかった時間: ${elapsed} 秒`;
        }
        score++;
        combo++;
        if(combo > maxCombo) maxCombo = combo;
        updateScoreBoard();
        setTimeout(newWord,1500);
    }
});

// 初期表示
updateScoreBoard();
newWord();
</script>
</body>
</html>
